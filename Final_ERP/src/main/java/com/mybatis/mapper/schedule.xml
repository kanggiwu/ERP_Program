<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="com.mybatis.mapper.ScheduleMapper">
	
	<!-- 처음 화면에 들어왔을 때의 현재 월의 일정 가져오기 -->
	<select id="getAttendanceThisMonth" parameterType="int" resultType="map">
		 SELECT attendance_no, emp_no, attendance_start_work
  		   FROM attendance
		  WHERE emp_no = #{emp_no}
    		AND attendance_start_work BETWEEN TRUNC(SYSDATE+1)-TO_CHAR(SYSDATE,'DD') AND TRUNC(LAST_DAY(SYSDATE))+0.99999421
	</select>
	
	<!-- 사용자가 선택한 월의 일정 리스트 가져오기 --> <!-- 해당 월의 날짜스트링 부분은 Dao 작성시 자바 변수명을 확인하여 추가 
	쿼리문 수정했습니다.attendance_start_work를 그대로 받아와야 DB에 있는 값으로 비교가 가능합니다.
	-->
	<select id="getAttendance" parameterType="string" resultType="map">
		 SELECT attendance_no, emp_no, attendance_start_work
         FROM attendance
         WHERE emp_no = #{emp_no}
         AND SUBSTR(attendance_start_work,3,5) = #{date}
	</select>

	<!-- 일정 조회  1:공통 2:프로젝트 3:개인 부서번호:부서 -->
	<select id="getScheduleList" parameterType="int" resultType="map">
		SELECT schedule_no, emp_no, schedule_title, schedule_startdate, schedule_enddate, schedule_content
 		  FROM schedule
		 <if test="schedule_type%10==0">
		 	WHERE schedule_type = (select dept_no from emp where emp_no =#{emp_no})
		 </if>
		 <if test="schedule_type%10!=0">
		 	WHERE schedule_type =#{schedule_type}
		 	<if test="schedule_type==3">
		 		and emp_no = #{emp_no}
		 	</if>
		 </if>
		 
	</select>
	
	<!-- 스케쥴 정보 입력 -->
	<insert id="insertSchedule" parameterType="map">
		<selectKey keyProperty="schedule_no" resultType="int" order="BEFORE">
		 	SELECT SEQ_SCHEDULE.NEXTVAL FROM DUAL 
		 </selectKey>
		INSERT INTO schedule (schedule_no, emp_no, schedule_type
		, schedule_title, schedule_startdate, schedule_enddate, schedule_content)
       	VALUES (#{schedule_no}, #{emp_no}, #{schedule_type}, #{schedule_title} , #{schedule_startdate}, #{schedule_enddate}, #{schedule_content})
	</insert>
	
	
<!-- ////////////////////////////////// 일정 수정 페이지/////////////////////////////////////////////////// -->

	<!-- 일정의 작성자가 맞는지 확인하기 위해 일정작성시 저장된 사원번호 불러오기 -->
	<select id="getScheduleWriter" parameterType="int" resultType="int">
		SELECT emp_no FROM schedule WHERE schedule_code = #{schedule_code};
	</select>
	
	<!-- 일정 수정 -->
	<update id="getBmNo" parameterType="map">
		UPDATE schedule
		SET 
    		emp_no = #{emp_no},
    		schedule_type = #{schedule_type},
    		schedule_title = #{schedule_title},
   			schedule_startdate = #{schedule_startdate},
			schedule_enddate = #{schedule_enddate},
		    schedule_content = #{schedule_content}
		WHERE  schedule_code = #{schedule_code};
	</update>
<!-- /////////////////////////////////////////////////////////////////////////////////////////////////// -->

	<!-- 일정 삭제 -->
	<delete id="deleteSchedule" parameterType="int">
		DELETE schedule WHERE schedule_code = #{schedule_code};
	</delete>

	<select id="getDept" parameterType="map" resultType="String">
		SELECT dept_no
		FROM emp
		WHERE emp_no=#{emp_no}
	</select>
</mapper>